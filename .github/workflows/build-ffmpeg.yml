name: MinGW Cross-Compile FFmpeg (RTX 2060)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  cross-compile:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # --- æ­¥éª¤ 1: å®‰è£…é€šç”¨ä¾èµ–å’Œ MinGW-w64 äº¤å‰ç¼–è¯‘å™¨ ---
      - name: ğŸ› ï¸ Install Toolchain and Dependencies
        run: |
          sudo apt update
          # å®‰è£… MinGW-w64 å·¥å…·é“¾ (ç”¨äº Windows 64-bit ç›®æ ‡)
          sudo apt install -y build-essential git wget yasm nasm pkg-config \
            g++-mingw-w64-x86-64 \
            # å®‰è£… Clang, å› ä¸º CUDA-LLVM/Clang æ˜¯ä¸€ä¸ªæ›´ç°ä»£çš„æ›¿ä»£æ–¹æ¡ˆ
            sudo apt install -y clang
          
          # å®šä¹‰ç›®æ ‡å˜é‡
          echo "TARGET_HOST=x86_64-w64-mingw32" >> $GITHUB_ENV

      # --- æ­¥éª¤ 2: å‡†å¤‡ CUDA/NVENC å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶ ---
      - name: ğŸ”‘ Unzip Windows CUDA SDK
        run: |
          # ç¡®ä¿ CUDA æ–‡ä»¶è§£å‹åˆ°ä¸€ä¸ªå¯é¢„æµ‹çš„è·¯å¾„
          mkdir -p /tmp/cuda-sdk
          unzip cuda-windows-sdk.zip -d /tmp/cuda-sdk
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨é¢„æœŸçš„å­ç›®å½•ä¸­ (ä¾‹å¦‚ /tmp/cuda-sdk/include, /tmp/cuda-sdk/lib/x64)
          ls -R /tmp/cuda-sdk
          
          echo "CUDA_INCLUDE_PATH=/tmp/cuda-sdk/include" >> $GITHUB_ENV
          echo "CUDA_LIB_PATH=/tmp/cuda-sdk/lib/x64" >> $GITHUB_ENV
          
      - name: â¬‡ï¸ Clone NV Codec Headers
        # NV Codec Headers æ˜¯ NVENC/NVDEC æ‰€éœ€çš„
        run: |
          git clone https://github.com/FFmpeg/nv-codec-headers.git
          cd nv-codec-headers
          # å®‰è£…åˆ° MinGW ç¯å¢ƒå¯ä»¥è¯†åˆ«çš„è·¯å¾„
          make install PREFIX=/usr/$TARGET_HOST
          
      # --- æ­¥éª¤ 3: ç¼–è¯‘ FFmpeg ---
      - name: ğŸ”¨ Compile FFmpeg
        run: |
          git clone https://git.ffmpeg.org/ffmpeg.git ffmpeg_src
          cd ffmpeg_src
          
          # äº¤å‰ç¼–è¯‘é…ç½®
          ./configure \
            --prefix=/usr/local/ffmpeg-win64 \
            --cross-prefix=${{ env.TARGET_HOST }}- \
            --target-os=mingw32 \
            --arch=x86_64 \
            --enable-cross-compile \
            --pkg-config-flags="--static" \
            --enable-gpl \
            --enable-version3 \
            --enable-static \
            --disable-shared \
            --disable-doc \
            --enable-nonfree \
            \
            # å¯ç”¨ CUDA/NVENC/NVDEC æ”¯æŒ
            --enable-cuda-nvcc \
            --enable-cuvid \
            --enable-nvenc \
            --enable-libnpp \
            \
            # **RTX 2060 çš„è®¡ç®—èƒ½åŠ›æ˜¯ 7.5 (sm_75)**
            --nvccflags="-gencode arch=compute_75,code=sm_75 -O2" \
            \
            # æŒ‡å®š Windows CUDA SDK çš„å¤´æ–‡ä»¶å’Œåº“è·¯å¾„
            --extra-cflags="-I${{ env.CUDA_INCLUDE_PATH }}" \
            --extra-ldflags="-L${{ env.CUDA_LIB_PATH }}" \
          
          make -j$(nproc)
          make install

      # --- æ­¥éª¤ 4: æ‰“åŒ…å’Œä¸Šä¼ ç»“æœ ---
      - name: ğŸ“¦ Archive and Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-win64-rtx2060-static
          path: /usr/local/ffmpeg-win64/bin/ffmpeg.exe
          retention-days: 7