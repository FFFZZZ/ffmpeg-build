name: MinGW Cross-Compile FFmpeg (RTX 2060)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  cross-compile:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # --- æ­¥éª¤ 1: å®‰è£…é€šç”¨ä¾èµ–å’Œ MinGW-w64 äº¤å‰ç¼–è¯‘å™¨ ---
      - name: ğŸ› ï¸ Install Toolchain and Dependencies
        run: |
          sudo apt update
          # å®‰è£… MinGW-w64 å·¥å…·é“¾ (ç”¨äº Windows 64-bit ç›®æ ‡)
          sudo apt install -y build-essential git wget yasm nasm pkg-config \
            g++-mingw-w64-x86-64 \
            # å®‰è£… Clang, å› ä¸º CUDA-LLVM/Clang æ˜¯ä¸€ä¸ªæ›´ç°ä»£çš„æ›¿ä»£æ–¹æ¡ˆ
            sudo apt install -y clang
          
            if [ -f /usr/bin/pkg-config ]; then
                # åˆ›å»ºä¸€ä¸ªå¸¦æœ‰ MinGW å‰ç¼€çš„ç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘æœ¬åœ°çš„ pkg-config
                sudo ln -s /usr/bin/pkg-config /usr/bin/x86_64-w64-mingw32-pkg-config
                echo "Created symbolic link for x86_64-w64-mingw32-pkg-config."
            else
                echo "Warning: Standard pkg-config not found, unable to create symlink."
            fi

      # --- æ­¥éª¤ 2: å‡†å¤‡ CUDA/NVENC å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶ ---
      - name: ğŸ”‘ Unzip Windows CUDA SDK
        run: |
          mkdir -p /tmp/cuda-sdk
          # æ›¿æ¢ä¸ºæ‚¨ Release Asset çš„å®é™…ä¸‹è½½é“¾æ¥
          # æ‚¨å¯ä»¥ä½¿ç”¨ GitHub CLI æˆ–ç›´æ¥é“¾æ¥
          CUDA_ZIP_URL="https://github.com/FFFZZZ/ffmpeg-build/releases/download/2026-1/cuda-windows-sdk.zip" 
          
          echo "Downloading CUDA SDK from $CUDA_ZIP_URL"
          curl -L "$CUDA_ZIP_URL" -o /tmp/cuda-sdk.zip
          unzip /tmp/cuda-sdk.zip -d /tmp/cuda-sdk
          ls -R /tmp/cuda-sdk # æ£€æŸ¥è§£å‹ç»“æœ
          
          echo "CUDA_INCLUDE_PATH=/tmp/cuda-sdk/include" >> $GITHUB_ENV
          echo "CUDA_LIB_PATH=/tmp/cuda-sdk/lib/x64" >> $GITHUB_ENV
          
      - name: â¬‡ï¸ Clone NV Codec Headers
        # NV Codec Headers æ˜¯ NVENC/NVDEC æ‰€éœ€çš„
        run: |
          # -----------------------------------------------------
          # ä¿®å¤: å¼ºåˆ¶åˆ›å»ºç›®æ ‡å®‰è£…ç›®å½•ï¼Œç¡®ä¿è·¯å¾„å­˜åœ¨
          # -----------------------------------------------------
          TARGET_DIR=/usr/${{ env.TARGET_HOST }}/include
          sudo mkdir -p $TARGET_DIR
          echo "Created installation directory: $TARGET_DIR"

          git clone https://github.com/FFmpeg/nv-codec-headers.git
          cd nv-codec-headers
          
          # ä½¿ç”¨ sudo ç¡®ä¿æœ‰æƒé™å†™å…¥ /usr/ ç›®å½•
          # PREFIX=/usr/${{ env.TARGET_HOST }} ä¼šå°†å¤´æ–‡ä»¶å®‰è£…åˆ° $TARGET_DIR
          sudo make install PREFIX=/usr/${{ env.TARGET_HOST }}
          
      # --- æ­¥éª¤ 3: ç¼–è¯‘ FFmpeg ---
      - name: ğŸ”¨ Compile FFmpeg
        run: |
          git clone https://git.ffmpeg.org/ffmpeg.git ffmpeg_src
          cd ffmpeg_src
          
          # äº¤å‰ç¼–è¯‘é…ç½®
          ./configure \
          --prefix=/usr/local/ffmpeg-win64 \
            --cross-prefix=${{ env.TARGET_HOST }}- \
            --target-os=mingw32 \
            --arch=x86_64 \
            --enable-cross-compile \
            --pkg-config-flags="--static" \
            --enable-gpl \
            --enable-version3 \
            --enable-static \
            --disable-shared \
            --disable-doc \
            --enable-nonfree \
            --enable-cuda-nvcc \
            --enable-cuvid \
            --enable-nvenc \
            --enable-libnpp \
            --nvccflags="-gencode arch=compute_75,code=sm_75 -O2" \
            --extra-cflags="-I${{ env.CUDA_INCLUDE_PATH }}" \
            --extra-ldflags="-L${{ env.CUDA_LIB_PATH }}" 
          make -j$(nproc)
          make install

      # --- æ­¥éª¤ 4: æ‰“åŒ…å’Œä¸Šä¼ ç»“æœ ---
      - name: ğŸ“¦ Archive and Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-win64-rtx2060-static
          path: /usr/local/ffmpeg-win64/bin/ffmpeg.exe
          retention-days: 7