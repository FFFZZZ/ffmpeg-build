name: Automated Windows FFmpeg Build with RTX 4060 Ti CUDA

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      # --- æ­¥éª¤ 1: å®‰è£…é€šç”¨ä¾èµ–å’Œ Build Helpers ---
      - name: ğŸ› ï¸ Install Dependencies and Get Helper Script
        run: |
          sudo apt update
          # å®‰è£…å¿…è¦çš„å·¥å…·
          sudo apt install -y build-essential curl unzip wget

          # ä¸‹è½½ rdp çš„ç¼–è¯‘è¾…åŠ©è„šæœ¬
          wget https://raw.githubusercontent.com/rdp/ffmpeg-windows-build-helpers/master/cross_compile_ffmpeg.sh -O cross_compile_ffmpeg.sh
          chmod +x cross_compile_ffmpeg.sh
          
      # --- æ­¥éª¤ 2: å‡†å¤‡ Windows CUDA æ–‡ä»¶ ---
      - name: ğŸ”‘ Unzip Windows CUDA SDK
        # å‡è®¾ 'cuda-windows-sdk.zip' åœ¨æ‚¨çš„ä»“åº“æ ¹ç›®å½•
        # æ­¤æ­¥éª¤è§£å‹åï¼Œè„šæœ¬å°†ä½¿ç”¨è¿™äº›æ–‡ä»¶è¿›è¡Œé“¾æ¥ã€‚
        run: |
          mkdir -p /tmp/cuda-sdk
          unzip cuda-windows-sdk.zip -d /tmp/cuda-sdk
          
          # æ£€æŸ¥è§£å‹åçš„è·¯å¾„æ˜¯å¦ç¬¦åˆè„šæœ¬é¢„æœŸ
          # è„šæœ¬é€šå¸¸åœ¨ sandbox/cuda ç›®å½•ä¸‹æŸ¥æ‰¾æ–‡ä»¶
          ls -R /tmp/cuda-sdk
          
      # --- æ­¥éª¤ 3: è¿è¡Œäº¤å‰ç¼–è¯‘è„šæœ¬ ---
      - name: ğŸ”¨ Run Cross-Compile Script for Win64
        env:
          # **å…³é”®ç¯å¢ƒå˜é‡**ï¼šæŒ‡æ˜ CUDA æ–‡ä»¶çš„æ ¹è·¯å¾„
          CUSTOM_CUDA_PATH: /tmp/cuda-sdk 
          
          # å¼ºåˆ¶å¯ç”¨ CUDA/NVENC/NVDEC
          BUILD_NVENC: YES
          
          # è¦†ç›– ffmpeg çš„é…ç½®é€‰é¡¹ï¼šå¯ç”¨ NVCC ç¼–è¯‘å’Œç›¸å…³ç»„ä»¶
          CUSTOM_CONFIG_OPTIONS: "--enable-cuda-nvcc --enable-cuvid --enable-nvenc --enable-libnpp"
          
          # **RTX 4060 Ti çš„è®¡ç®—èƒ½åŠ› (8.9)**
          CUSTOM_NVCC_FLAGS: "-gencode arch=compute_75,code=sm_75 -O2"
          
        run: |
          ./cross_compile_ffmpeg.sh 64
          
      # --- æ­¥éª¤ 4: æ‰“åŒ…å’Œä¸Šä¼ ç»“æœ ---
      - name: ğŸ“¦ Archive and Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-win64-cuda-rtx4060ti-static
          # è„šæœ¬çš„è¾“å‡ºè·¯å¾„é€šå¸¸åœ¨ sandbox ç›®å½•ä¸‹
          path: |
            sandbox/x86_64/ffmpeg.exe
            sandbox/x86_64/ffprobe.exe
          retention-days: 7