name: Automated Windows FFmpeg Build with RTX 4060 Ti CUDA

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      # --- æ­¥éª¤ 1: å®‰è£…é€šç”¨ä¾èµ–å’Œ Build Helpers ---
      - name: ğŸ› ï¸ Install Dependencies and Get Helper Script
        run: |
          sudo apt update
          # å®‰è£…å¿…è¦çš„å·¥å…·
          sudo apt install -y build-essential curl unzip wget subversion ragel curl texinfo g++ ed bison flex cvs yasm automake libtool autoconf gcc cmake git make pkg-config zlib1g-dev pax nasm gperf autogen bzip2 autoconf-archive p7zip-full meson clang python3-distutils python-is-python3 -y

          # ä¸‹è½½ rdp çš„ç¼–è¯‘è¾…åŠ©è„šæœ¬
          wget https://raw.githubusercontent.com/rdp/ffmpeg-windows-build-helpers/master/cross_compile_ffmpeg.sh -O cross_compile_ffmpeg.sh
          chmod +x cross_compile_ffmpeg.sh
          
      # --- æ­¥éª¤ 2: å‡†å¤‡ Windows CUDA æ–‡ä»¶ ---
      - name: ğŸ”‘ Unzip Windows CUDA SDK
        # å‡è®¾ 'cuda-windows-sdk.zip' åœ¨æ‚¨çš„ä»“åº“æ ¹ç›®å½•
        # æ­¤æ­¥éª¤è§£å‹åï¼Œè„šæœ¬å°†ä½¿ç”¨è¿™äº›æ–‡ä»¶è¿›è¡Œé“¾æ¥ã€‚
        run: |
          mkdir -p /tmp/cuda-sdk
          # æ›¿æ¢ä¸ºæ‚¨ Release Asset çš„å®é™…ä¸‹è½½é“¾æ¥
          # æ‚¨å¯ä»¥ä½¿ç”¨ GitHub CLI æˆ–ç›´æ¥é“¾æ¥
          CUDA_ZIP_URL="https://release-assets.githubusercontent.com/github-production-release-asset/1110282498/07980b0a-1ac7-4b5d-ba34-bce64c4861a9?sp=r&sv=2018-11-09&sr=b&spr=https&se=2025-12-05T02%3A18%3A26Z&rscd=attachment%3B+filename%3Dcuda-windows-sdk.zip&rsct=application%2Foctet-stream&skoid=96c2d410-5711-43a1-aedd-ab1947aa7ab0&sktid=398a6654-997b-47e9-b12b-9515b896b4de&skt=2025-12-05T01%3A18%3A11Z&ske=2025-12-05T02%3A18%3A26Z&sks=b&skv=2018-11-09&sig=idL45gezTMdRFivikc98OK9mhB2hkmQUkZOAPOxQnQI%3D&jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmVsZWFzZS1hc3NldHMuZ2l0aHVidXNlcmNvbnRlbnQuY29tIiwia2V5Ijoia2V5MSIsImV4cCI6MTc2NDkwMTczMywibmJmIjoxNzY0ODk4MTMzLCJwYXRoIjoicmVsZWFzZWFzc2V0cHJvZHVjdGlvbi5ibG9iLmNvcmUud2luZG93cy5uZXQifQ.ZZVbqE6aBjUD4U6zHfVosbiHIs26mR2s6eooBc8o-7g&response-content-disposition=attachment%3B%20filename%3Dcuda-windows-sdk.zip&response-content-type=application%2Foctet-stream" 
          
          echo "Downloading CUDA SDK from $CUDA_ZIP_URL"
          curl -L "$CUDA_ZIP_URL" -o /tmp/cuda-sdk.zip
          unzip /tmp/cuda-sdk.zip -d /tmp/cuda-sdk
          ls -R /tmp/cuda-sdk # æ£€æŸ¥è§£å‹ç»“æœ
          
      # --- æ­¥éª¤ 3: è¿è¡Œäº¤å‰ç¼–è¯‘è„šæœ¬ ---
      - name: ğŸ”¨ Run Cross-Compile Script for Win64
        env:
          # **å…³é”®ç¯å¢ƒå˜é‡**ï¼šæŒ‡æ˜ CUDA æ–‡ä»¶çš„æ ¹è·¯å¾„
          CUSTOM_CUDA_PATH: /tmp/cuda-sdk 
          
          # å¼ºåˆ¶å¯ç”¨ CUDA/NVENC/NVDEC
          BUILD_NVENC: YES
          
          # è¦†ç›– ffmpeg çš„é…ç½®é€‰é¡¹ï¼šå¯ç”¨ NVCC ç¼–è¯‘å’Œç›¸å…³ç»„ä»¶
          CUSTOM_CONFIG_OPTIONS: "--enable-cuda-nvcc --enable-cuvid --enable-nvenc --enable-libnpp"
          
          # **RTX 4060 Ti çš„è®¡ç®—èƒ½åŠ› (8.9)**
          CUSTOM_NVCC_FLAGS: "-gencode arch=compute_75,code=sm_75 -O2"
          
        run: |
          ./cross_compile_ffmpeg.sh 64
          
      # --- æ­¥éª¤ 4: æ‰“åŒ…å’Œä¸Šä¼ ç»“æœ ---
      - name: ğŸ“¦ Archive and Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-win64-cuda-rtx4060ti-static
          # è„šæœ¬çš„è¾“å‡ºè·¯å¾„é€šå¸¸åœ¨ sandbox ç›®å½•ä¸‹
          path: |
            sandbox/x86_64/ffmpeg.exe
            sandbox/x86_64/ffprobe.exe
          retention-days: 7